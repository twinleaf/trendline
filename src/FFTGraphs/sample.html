<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name ="viewport" content=""width=device-width, initial-scales="1.0">
  </head>

  <body>
    <main id="canvases" style = "resize: both ">       
      <div id = "transform" class = "canvas-container"></div>  
      
      <script>
        const { listen } = window.__TAURI__.event;
        const { getCurrentWebviewWindow } = window.__TAURI__.webviewWindow;

        webpage = getCurrentWebviewWindow();
        window.onload = () => {
            let fft = [];
 
            webpage.listen('pump1', (event) => {
                const [freq, power_spec] = event.payload;
                renderFFT(freq, power_spec, 'transform', fft)
                fft.forEach((chart) => {
                    for (let i = 0; i< freq.length; i++) {
                        chart.data[0].push(freq[i]) 
                        chart.data[1].push(power_spec[i])
                    }
                
                    while (chart.data[0].length > 1000){
                        chart.data[0].shift();
                        chart.data[1].shift();
                    }
                    chart.setData(chart.data, true);
                }) 
            })

            webpage.listen('pump2', (event) => {
                const [freq, power_spec] = event.payload;
                renderFFT(freq, power_spec, 'transform', fft)

                fft.forEach((chart) => {
                    for (let i = 0; i< freq.length; i++) {
                        chart.data[0].push(freq[i]) 
                        chart.data[1].push(power_spec[i])
                    }
                
                    while (chart.data[0].length > 1000){
                        chart.data[0].shift();
                        chart.data[1].shift();
                    }
                    chart.setData(chart.data, true);
                }) 
            })

            webpage.listen('lockin', (event) => {
                const [freq, power_spec] = event.payload;
                renderFFT(freq, power_spec, 'transform', fft)

                fft.forEach((chart) => {
                    for (let i = 0; i< freq.length; i++) {
                        chart.data[0].push(freq[i]) 
                        chart.data[1].push(power_spec[i])
                    }
                
                    while (chart.data[0].length > 1000){
                        chart.data[0].shift();
                        chart.data[1].shift();
                    }
                    chart.setData(chart.data, true);
                }) 
            })
        };

        function renderFFT(frequencies, powerSpectrum, elementId, fftArray) {
            setTimeout(() => {
                const fftGraphContainer = document.getElementById(elementId);
                const fftPlot = new uPlot({
                    
                    title: 'FFT',
                    width: 800, 
                    height: 300,
                    series: [
                        {   label: "Frequency (Hz)"},
                        { 
                            label: "Power Spectrum (V/âˆšHz)",
                            stroke: 'blue',
                            points: { show: false },    
                        },
                    ],
                    scales: {
                        x: {
                        time: false,
                        auto: true,
                        distr: 3
                        },
                        y: {distr: 3}
                    },
                    axes: [
                        {},
                        {   size: 100,
                            values: (u, v) => v
                        }]
                }, [frequencies, powerSpectrum], fftGraphContainer);
                fftArray.push(fftPlot)
                
                makeResizable(elementId, fftPlot)
            }, 200);
            
        }

        function makeResizable(elementId, uplotResize){
            const element = document.getElementById(elementId);
            interact(element).resizable({
                edges: {left: true, right: true, bottom: true, top:true},
                inertia: true,
                listeners: {
                    move(event) {
                        const target = event.target;
                        let width = event.rect.width;
                        let height = event.rect.height;

                        target.style.width = `${width}px`
                        target.style.height = `${height}px`

                        uplotResize.setSize({width, height});
                    }
                },
                modifiers: [
                    interact.modifiers.restrict({
                        restriction: 'parent'
                    }),
                    
                    interact.modifiers.restrictSize({
                        min: {width: 400, height: 200}
                    })
                ]
            })
        }
      </script>
      <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.31/dist/uPlot.min.css" />
      <script src = "https://cdn.jsdelivr.net/npm/uplot@1.6.31/dist/uPlot.iife.min.js"></script>
    </main>

  </body>
</html>
